---
title: "Charlottesville Twitter Data"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
# Load libraries needed
library(flexdashboard); 
library(tidyverse); 
library(plotly); 
library(stm); 
library(scales);
library(shinyWidgets);
library(visNetwork);
library(igraph)

# Load the input file (see .R file)
load(file = "data/tweet_topic_df.RData")
load(file = "data/topicDF.RData")
load(file = "data/network.RData")

# Convert IDs to numeric
df$id <- as.numeric(df$id)
```

Inputs {.sidebar}
-------------------------------------

```{r}
# Set input for the topic
selectInput("topicNum", label = "1st Topic", choices = topicDF$Prob)
# Set input for the x-range
sliderInput("xaxis", label = "X Range",
            min = 0, max = 1, value = c(0, 0.2), step = 0.05)
# Set input for the y-range
sliderInput("yaxis", label = "Y Range",
            min = 0, max = 150, value = 100, step = 0.05)
# Set input for the adjustment
sliderInput("adjust", label = "Adjustment",
            min = 0, max = 3, value = 1, step = 0.1)
# Set input for the bin width
#sliderInput("histogramBin", label = "Histogram Bin",
#            min = 0, max = 0.1, value = 0.01, step = 0.001)
# Set input for choosing the graph type: histogram or density
# switchInput(inputId = "Histogram", value = TRUE, width = '500px')
```

Row {.tabset .tabset-fade}
-------------------------------------
    
### Density Plot

```{r}
# Call renderPlotly
renderPlotly({
  name <- topicDF$topicNum[topicDF$Prob == input$topicNum]
  # Construct the ggplot for that topic using Gaussian as the kernel density
  g <- df %>%
    # Select the columns VX (X: topic number) and hotIssue from the df
    select(name, hotIssue) %>%
    # Spread the selected the rows by the "topic", "Probability", name (which is the topic number VX)
    gather("topic", "Probability", name) %>%
    # Create a gglplot where the aesthetic is the Probability and the color is the hotIssue
    ggplot(aes(x = Probability, color = hotIssue)) +
    # Make hte ggplot a gaussian kernel density function with an adjustment
    geom_density(kernel = "gaussian", adjust = input$adjust) +
    theme(legend.position = "none") +
    xlim(input$xaxis[1],input$xaxis[2]) +
    ylim(0,input$yaxis)
  # Use ggplotly to plot the ggplot
  ggplotly(g, tooltip = c("y","x","colour"))
})
```

### Selected Tweets

```{r}
#https://plot.ly/r/shiny-coupled-events/
# Call renderDataTable from DT library
DT::renderDataTable({
  # Set the event listener
  event.data <- event_data("plotly_relayout")
  # Set the max and min according to the event
  min <- event.data$`xaxis.range[0]`
  max <- event.data$`xaxis.range[1]`

  # Get the column name of the probabilities displayed
  name <- topicDF$topicNum[topicDF$Prob == input$topicNum]
  
  # Pass the df to a pipeline
  t <- df %>%
    # Select the columns name (which is actually VX), screenName, body, postedTime, hostIssue, local
    select(name, screenName, body, postedTime, hotIssue, local) %>%
    # Spread the rows by the "topic", "Probability", name (which is the topic number VX)
    gather("topic", "Probability", name) %>%
    filter(Probability < max & Probability > min) %>%
    select(-topic) %>%
    mutate(Probability = round(Probability, 5)) %>%
    arrange(desc(Probability))

  # Create a DataTable from t
  DT::datatable(t, 
                filter = 'top', 
                extensions = 'Buttons',
                options = list(
                    # Options we discarded but may need later
                    # dom = 'Bfrtip',
                    # autoHeight = TRUE,
                    # deferRender = TRUE,
                    #scroller = TRUE
                    # Initial number of rows displayed (-1 means all)
                    pageLength = -1,
                    # Menu for selecting how many rows to be displayed
                    lengthMenu = c(15, 20, 50, 100, -1),
                    # Exporting options
                    buttons = c('copy', 'csv', 'excel'),
                    scrollY = 700
                    ),
                rownames = FALSE)
})
```

### Topic Overview

```{r}
renderVisNetwork({
  visNetwork(net[[1]], net[[2]], width="100%",  height="600px", main=" ") %>%   
    visOptions(highlightNearest = list(enabled = TRUE, algorithm = "hierarchical")) %>%
    visInteraction(navigationButtons = TRUE) 
})
```